<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Twin Gladius</title>
  <style>
    body { margin:0; background:black; overflow:hidden; }
    canvas { display:block; margin:0 auto; background:#111; }
    #controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
    }
    .btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      touch-action: none;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="480" height="640"></canvas>
  <div id="controls">
    <div class="btn" id="leftBtn"></div>
    <div class="btn" id="shootBtn"></div>
    <div class="btn" id="rightBtn"></div>
  </div>
  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    let keys = {};
    document.addEventListener("keydown", e => keys[e.key] = true);
    document.addEventListener("keyup", e => keys[e.key] = false);

    // タッチ用
    const leftBtn = document.getElementById("leftBtn");
    const rightBtn = document.getElementById("rightBtn");
    const shootBtn = document.getElementById("shootBtn");

    let touchLeft = false, touchRight = false, touchShoot = false;

    leftBtn.addEventListener("touchstart", () => touchLeft = true);
    leftBtn.addEventListener("touchend", () => touchLeft = false);
    rightBtn.addEventListener("touchstart", () => touchRight = true);
    rightBtn.addEventListener("touchend", () => touchRight = false);
    shootBtn.addEventListener("touchstart", () => touchShoot = true);
    shootBtn.addEventListener("touchend", () => touchShoot = false);

    let score = 0;

    const player = {
      x: canvas.width/2,
      y: canvas.height-60,
      speed: 4,
      bullets: [],
      options: [],
      maxOptions: 5,
      shield: 0
    };

    function shoot(){
      player.bullets.push({x:player.x, y:player.y-10, dy:-6});
      player.options.forEach(opt => {
        player.bullets.push({x:opt.x, y:opt.y-10, dy:-6});
      });
    }

    function addOption(){
      if(player.options.length < player.maxOptions){
        player.options.push({x:player.x, y:player.y});
      }
    }
    player.addOption = addOption;

    const enemies = [];
    function spawnEnemy(){
      enemies.push({x:Math.random()*440+20,y:-20,dy:2,hp:1});
    }

    const bells = [];
    const BELL_TYPES = {
      YELLOW: 'yellow', // スコア
      GREEN: 'green',   // 仲間追加
      BLUE: 'blue'      // シールド
    };
    function spawnBell(){
      const types = [BELL_TYPES.YELLOW,BELL_TYPES.GREEN,BELL_TYPES.BLUE];
      const type = types[Math.floor(Math.random()*types.length)];
      bells.push({x:Math.random()*440+20,y:-20,dy:1,type});
    }

    function collectBell(bell){
      switch(bell.type){
        case BELL_TYPES.GREEN:
          if(player.options.length < player.maxOptions){
            player.addOption();
          }
          break;
        case BELL_TYPES.BLUE:
          player.shield = 600; // 約10秒シールド
          break;
        case BELL_TYPES.YELLOW:
        default:
          score += 1000;
          break;
      }
    }

    function update(){
      // 移動
      if(keys["ArrowLeft"]||keys["a"]||touchLeft){ player.x -= player.speed; }
      if(keys["ArrowRight"]||keys["d"]||touchRight){ player.x += player.speed; }
      if(player.x<20) player.x=20;
      if(player.x>canvas.width-20) player.x=canvas.width-20;

      // 射撃
      if(keys[" "]||keys["z"]||keys["x"]||touchShoot){
        if(frameCount%10===0) shoot();
      }

      // 弾更新
      player.bullets.forEach(b=>b.y+=b.dy);
      player.bullets = player.bullets.filter(b=>b.y>-10);

      // 仲間追従
      player.options.forEach((opt,i)=>{
        opt.x += (player.x - opt.x)*0.1;
        opt.y = player.y - 30 - i*20;
      });

      // 敵更新
      enemies.forEach(e=>e.y+=e.dy);
      enemies.forEach(e=>{
        player.bullets.forEach(b=>{
          if(Math.abs(e.x-b.x)<10 && Math.abs(e.y-b.y)<10){
            e.hp=0;
            b.y=-100;
            score+=100;
          }
        });
      });
      enemies.filter(e=>e.hp>0);

      // ベル更新
      bells.forEach(b=>b.y+=b.dy);
      bells.forEach(b=>{
        if(Math.abs(player.x-b.x)<15 && Math.abs(player.y-b.y)<15){
          collectBell(b);
          b.y=1000;
        }
      });

      if(player.shield>0) player.shield--;

      // spawn
      if(frameCount%60===0) spawnEnemy();
      if(frameCount%300===0) spawnBell();
    }

    function draw(){
      ctx.fillStyle="black";
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // プレイヤー
      ctx.fillStyle="lime";
      ctx.fillRect(player.x-10,player.y-10,20,20);
      // シールド描画
      if(player.shield>0){
        ctx.beginPath();
        ctx.arc(player.x,player.y,30,0,Math.PI*2);
        ctx.strokeStyle="cyan";
        ctx.lineWidth=3;
        ctx.stroke();
      }

      // 仲間
      ctx.fillStyle="lightgreen";
      player.options.forEach(opt=>ctx.fillRect(opt.x-8,opt.y-8,16,16));

      // 弾
      ctx.fillStyle="white";
      player.bullets.forEach(b=>ctx.fillRect(b.x-2,b.y-5,4,10));

      // 敵
      ctx.fillStyle="red";
      enemies.forEach(e=>ctx.fillRect(e.x-10,e.y-10,20,20));

      // ベル
      bells.forEach(b=>{
        if(b.type===BELL_TYPES.GREEN) ctx.fillStyle="green";
        else if(b.type===BELL_TYPES.BLUE) ctx.fillStyle="cyan";
        else ctx.fillStyle="yellow";
        ctx.beginPath();
        ctx.arc(b.x,b.y,10,0,Math.PI*2);
        ctx.fill();
      });

      // スコア
      ctx.fillStyle="white";
      ctx.fillText("SCORE: "+score,10,20);
    }

    let frameCount=0;
    function loop(){
      frameCount++;
      update();
      draw();
      requestAnimationFrame(loop);
    }
    loop();
  </script>
</body>
</html>
